<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <link href="https://fonts.googleapis.com/css?family=Merienda+One|Open+Sans&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
        }

        h2,
        .v-toolbar__title {
            font-family: 'Merienda One', cursive;
            margin-bottom: 5px;
        }
    </style>

    {% if PROD %}
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-7792152-10"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-7792152-10');
    </script>
    {% endif %}
</head>

{% comment %}
lime lighten-2
lime lighten-5
lime darken-3
deep-purple lighten-1
{% endcomment %}

<body>
    <v-app id="app" style="background-color: #F9FBE7;">
        <v-app-bar app color="lime darken-3" dark elevate-on-scroll>
            <!-- <v-app-bar-nav-icon @click.stop="drawer = !drawer"></v-app-bar-nav-icon> -->
            <v-toolbar-title>Apoie Produtores Locais</v-toolbar-title>
        </v-app-bar>

        <!-- <v-navigation-drawer app v-model="drawer">
            <v-list dense>
                <v-list-item link>
                    <v-list-item-action>
                        <v-icon>mdi-home</v-icon>
                    </v-list-item-action>
                    <v-list-item-content>
                        <v-list-item-title>Home</v-list-item-title>
                    </v-list-item-content>
                </v-list-item>
            </v-list>
        </v-navigation-drawer> -->

        <v-content>
            <v-container fluid>
                <v-overlay :value="loading.length > 0" style="z-index: 3000">
                    <v-layout row justify-center align-center>
                        <v-progress-circular indeterminate :size="128" :width="8" color="deep-purple lighten-1">
                        </v-progress-circular>
                    </v-layout>
                </v-overlay>
                <v-row class="mx-0">
                    <v-col cols="12" md="6" v-if="estadoAtual === estadoLista">
                        <v-sheet color="lime lighten-2" tile>
                            <v-sheet color="lime lighten-2" class="pa-3" tile>
                                <h2>Sobre</h2>
                                <p>A ideia dessa página é centralizar as informações de pequenos produtores no DF.</p>
                                <p class="mb-0">Dessa forma podemos encontrar padronizar as listas que tem circulado
                                    pelas redes sociais.</p>
                            </v-sheet>

                            <v-col cols="12" class="hidden-sm-and-down">
                                <v-divider></v-divider>
                            </v-col>

                            <v-sheet class="pa-3 hidden-sm-and-down" color="lime lighten-2" tile>
                                <h2>Filtros</h2>
                                <v-col md="4">
                                    <v-text-field v-model="pesquisa.nome" label="Nome" placeholder="Digite um nome"
                                        outlined>
                                    </v-text-field>
                                </v-col>
                            </v-sheet>
                    </v-col>

                    <v-col cols="12" class="hidden-md-and-up" v-if="estadoAtual === estadoLista">
                        <v-divider></v-divider>
                    </v-col>

                    <v-col cols="12" md="6" v-if="estadoAtual === estadoLista">
                        <v-sheet color="lime lighten-2" tile>
                            <v-sheet color="lime lighten-2" class="pa-3" tile>
                                <h2>Negócios</h2>
                                <v-card>
                                    <v-list class="py-0" color="lime lighten-5" two-line max-height="600"
                                        style="overflow-y: scroll;">
                                        <v-list-item-group multiple active-class="pink--text">
                                            <template v-for="(negocio, index) in negociosFiltrados">
                                                <v-list-item @click="selecionarNegocio(negocio)">
                                                    <template v-slot:default="{ active, toggle }">
                                                        <v-list-item-content>
                                                            <v-list-item-title>
                                                                <span>[[ negocio.nome ]]</span>
                                                                <span v-if="negocio.instagram.length > 0">
                                                                    <a :href="negocio.instagram"
                                                                        style="text-decoration: none !important;">
                                                                        <v-icon>mdi-instagram</v-icon>
                                                                    </a>
                                                                </span>
                                                            </v-list-item-title>
                                                            <v-list-item-subtitle class="text--primary"
                                                                v-text="negocio.endereco">
                                                            </v-list-item-subtitle>

                                                            <template
                                                                v-for="(contato, indexContato) in negocio.contatos">
                                                                <v-list-item-subtitle>
                                                                    <span>
                                                                        <span>[[ contato.nome_telefone ]]
                                                                            <a v-if="contato.whatsapp"
                                                                                :href="contato.whatsapp"
                                                                                style="text-decoration: none !important;">
                                                                                <v-icon>mdi-whatsapp</v-icon>
                                                                            </a></span>
                                                                    </span>
                                                                </v-list-item-subtitle>
                                                            </template>
                                                        </v-list-item-content>
                                                    </template>
                                                </v-list-item>
                                                <v-divider v-if="index + 1 < negociosFiltrados.length" :key="index">
                                                </v-divider>
                                            </template>
                                        </v-list-item-group>
                                    </v-list>
                                </v-card>
                            </v-sheet>
                        </v-sheet>
                    </v-col>

                    <v-col cols="12" v-if="estadoAtual === estadoDetalhe">
                        <v-sheet color="lime lighten-2" tile>
                            <v-sheet color="lime lighten-2" class="pa-3" tile>
                                <a href="javascript:;" @click="voltarLista()" style="text-decoration: none !important;">
                                    <v-icon large>mdi-arrow-left</v-icon>
                                </a>

                                <v-row>
                                    <v-col cols="12" class="py-0">
                                        <h2>[[ negocioSelecionado.nome ]]
                                            <span v-if="negocioSelecionado.instagram.length > 0">
                                                <a :href="negocioSelecionado.instagram"
                                                    style="text-decoration: none !important;">
                                                    <v-icon large>mdi-instagram</v-icon>
                                                </a>
                                            </span>
                                        </h2>
                                    </v-col>
                                    <v-col cols="12" class="py-0">
                                        <h4>[[negocioSelecionado.endereco]]</h4>
                                    </v-col>

                                    <v-col cols="12" md="3" class="py-0">
                                        <h4 class="mt-2">Contatos</h4>
                                        <v-col cols="12" class="pa-0"
                                            v-for="(contato, indexContato) in negocioSelecionado.contatos">
                                            <span>[[ contato.nome_telefone ]]
                                                <a v-if="contato.whatsapp" :href="contato.whatsapp"
                                                    style="text-decoration: none !important;">
                                                    <v-icon>mdi-whatsapp</v-icon>
                                                </a>
                                            </span>
                                        </v-col>
                                    </v-col>

                                    <v-col cols="12" md="3" class="py-0">
                                        <h4 class="mt-2">Formas de pagamento</h4>
                                        <span>[[ negocioSelecionado.formas_pagamento ]]</span>
                                    </v-col>

                                    <v-col cols="12" md="3" class="py-0">
                                        <h4 class="mt-2">Formas de entrega</h4>
                                        <span>[[ formatarFormaEntrega(negocioSelecionado.formas_entrega)
                                            ]]</span>
                                    </v-col>

                                    <v-col cols="12" md="3" class="py-0">
                                        <h4 v-if="negocioSelecionado.valor_minimo > 0" class="mt-2">
                                            Valor mínimo do pedido
                                        </h4>
                                        <span>[[ formatarPreco(negocioSelecionado.valor_minimo)
                                            ]]</span>
                                    </v-col>

                                    <v-col cols="12" md="4" class="py-0">
                                        <h4 class="mt-2">Produtos</h4>
                                        <v-col cols="12" class="pa-0"
                                            v-for="(produto, indexProduto) in negocioSelecionado.produtos">
                                            <v-row>
                                                <v-col cols="8" class="py-0">
                                                    <span>[[ produto.nome ]]</span>
                                                </v-col>
                                                <v-col cols="4" class="py-0 pl-0">
                                                    <span v-if="produto.preco > 0"
                                                        class="float-right font-weight-bold">[[
                                                        formatarPreco(produto.preco)
                                                        ]]</span>
                                                </v-col>
                                            </v-row>
                                        </v-col>
                                    </v-col>
                                </v-row>
                            </v-sheet>
                        </v-sheet>
                    </v-col>
                </v-row>
            </v-container>
        </v-content>
        <v-footer app color="lime darken-3" absolute class="py-0">
            <v-col class="text-center py-1" cols="12">
                <span class="white--text">Feito por <a class="deep-purple--text text--lighten-1"
                        href="https://twitter.com/gui_niz" style="text-decoration: none !important;">@gui_niz</a></span>
            </v-col>
        </v-footer>
    </v-app>

    {% if PROD %}
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    {% else %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const ESTADO_LISTA = 1;
        const ESTADO_DETALHE = 2;

        let app = new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            vuetify: new Vuetify({
                lang: {
                    current: 'pt-br',
                },
            }),

            data: {
                negocios: [],
                negocioSelecionado: null,
                drawer: false,

                estadoAtual: ESTADO_LISTA,
                estadoLista: ESTADO_LISTA,
                estadoDetalhe: ESTADO_DETALHE,

                pesquisa: {
                    nome: ''
                },

                loading: []
            },

            computed: {
                negociosFiltrados: function () {
                    var lista = [];

                    const nomePesquisa = this.pesquisa.nome.toLowerCase();

                    for (negocio of this.negocios) {
                        if (negocio.nome.toLowerCase().indexOf(nomePesquisa) > -1) {
                            lista.push(negocio);
                        }
                    }

                    function compare(a, b) {
                        if (a.nome < b.nome)
                            return -1;
                        if (a.nome > b.nome)
                            return 1;
                        if (a.id < b.id)
                            return -1;
                        if (a.id > b.id)
                            return 1;
                        return 0;
                    }

                    return lista.sort(compare);
                }
            },

            methods: {
                formatarPreco(preco) {
                    if (!preco) return 0;
                    var centavos = String(preco % 100);
                    if (centavos.length < 2) {
                        centavos = "0".concat(centavos);
                    }
                    return `R$ ${Math.floor(preco / 100)},${centavos}`;
                },
                formatarTelefone(telefone) {
                    if (!telefone) return null;

                    const ddd = telefone.substring(0, 2);
                    const parte1 = telefone.substring(2, telefone.length - 4);
                    const parte2 = telefone.substring(telefone.length - 4);
                    return `(${ddd}) ${parte1}-${parte2}`
                },
                formatarFormaEntrega(formasEntrega) {
                    if (!formasEntrega) return null;

                    switch (formasEntrega) {
                        case 1:
                            return 'Delivery';
                        case 2:
                            return 'Take Out';
                        case 3:
                            return 'Delivery e Take Out';
                        default:
                            return null;
                    }
                },
                selecionarNegocio(negocio) {
                    this.negocioSelecionado = negocio;
                    this.negocioSelecionado.produtos = [];
                    this.estadoAtual = this.estadoDetalhe;

                    this.loading.push(1);
                    axios
                        .get(`/api/negocios/${this.negocioSelecionado.id}/produtos/`)
                        .then(response => {
                            this.loading.pop();
                            this.negocioSelecionado.produtos = response.data;
                        });
                },
                voltarLista() {
                    this.negocioSelecionado = null;
                    this.estadoAtual = this.estadoLista;
                }
            },

            mounted() {
                axios
                    .get('/api/negocios/')
                    .then(response => {
                        this.negocios = response.data;
                        for (negocio of this.negocios) {
                            // Preparar link instagram
                            if (negocio.instagram.length > 0) {
                                negocio.instagram = 'https://instagram.com/' + negocio.instagram;
                            }

                            for (contato of negocio.contatos) {
                                if (contato.nome.length > 0) {
                                    contato.nome_telefone = contato.nome + ' ' + this.formatarTelefone(contato.telefone);
                                } else {
                                    contato.nome_telefone = this.formatarTelefone(contato.telefone);
                                }

                                // Preparar link whatsapp
                                if (contato.possui_whatsapp) {
                                    contato.whatsapp = "https://wa.me/55" + contato.telefone;
                                }
                            }
                        }
                    });
            }
        })
    </script>
</body>

</html>